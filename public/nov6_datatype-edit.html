<html>
    
    <head>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js">
        </script>
        <!--jquery ui autocomplete- http://docs.jquery.com/Plugins/Autocomplete-->
        <!--<link rel="stylesheet" href="http://dev.jquery.com/view/trunk/plugins/autocomplete/demo/main.css"
        type="text/css" />
        -->
        <link rel="stylesheet" href="http://dev.jquery.com/view/trunk/plugins/autocomplete/jquery.autocomplete.css"
        type="text/css" />
        <script type="text/javascript" src="http://dev.jquery.com/view/trunk/plugins/autocomplete/lib/jquery.bgiframe.min.js">
        </script>
        <!--<script type="text/javascript" src="http://dev.jquery.com/view/trunk/plugins/autocomplete/lib/jquery.dimensions.js"></script>-->
        <script type="text/javascript" src="http://dev.jquery.com/view/trunk/plugins/autocomplete/jquery.autocomplete.js">
        </script>
        <script type="text/javascript">
 
 
            var fieldCount = 1; //global var keeping track of how many filters we added

            //api
            function loadDataTypeTags() {

                $('#datatype_tags').bind('populateTags', function(event, returned_tags) {
                      args = Array.prototype.slice.call(arguments);//convert to array
                      tags = args.slice(1,arguments.length); //take only last part (tags) since first one is the event
                      $("#datatype_tags").autocomplete(tags, {
                                                      width: 320,
                                                      max: 4,
                                                      highlight: false,
                                                      multiple: true,
                                                      multipleSeparator: " ",
                                                      scroll: true,
                                                      scrollHeight: 300
                                                    })
                    });

                $.ajax({
                    url: 'tags', //api call url
                    success: function(returned_tags) {//
                       $("#datatype_tags").trigger('populateTags', returned_tags);
                    }
                })
            }

            function loadDataTypeNames() {

                $('#datatype_name').bind('populateNames', function(event, returned_names) {
                      args = Array.prototype.slice.call(arguments);//convert to array
                      names = args.slice(1,arguments.length); //take only last part (tags) since first one is the event
                      $("#datatype_name").autocomplete(names);
                });

                $.ajax({
                    url: 'names', //api call url
                    success: function(returned_names) {
                            $("#datatype_name").trigger('populateNames', returned_names);
                    }
                })
            }



            //load all data by making the appropriate ajax calls to api


            function loadData() {
                $.ajaxSetup({
                    cache: false
                })
                loadDataTypeTags();
                loadDataTypeNames();
            }



            //determine data type based on :type
            //parse accordingly and populate form fields        

            function parseAndPopulate(data) {
             
              //this is just for "Datatype" type
              window.mydata = data;//temp

              //fields
              removeDatatypeFields();
              addField();
              for (i = 1; i++; i<=data.fields.length) {
                alert("in the loop with i:"+i.toString());
                addField();
              }
              $("#datatype_tags").val(data.tags.toString().replace(",", " "));//need to cast to string
              //for (t in data.tags) {
                //$("#datatype_tags").val( $("#datatype_tags").val() + t + " " );

             // }
            }



            function removeDatatypeFields() {
              $('.fieldItem').remove();
              window.fieldCount = 1;
            }



            //document ready ================================

            $(document).ready(function() {
              loadData();

              //replace submit on enter for datatype name field
              //with a call to search db for datatype with given name
              $('#datatype_name').keypress(function(e) {

                      if (e.keyCode === 13) 
                      {

                      $.ajax({
                          url: 'search_by_name', //api call url
                          data: { name_value: $(this).val() },
                          success: function(returned_datatype) {
                            parseAndPopulate(returned_datatype);
                          //alert("search results:"+returned_datatype.datatype_name);
                          }
                      });
       
                        return false; //prevent form from being submitted
                        //$(this).closest('form').trigger('submit');
                      }

                  });


              });

            //end document ready =============================



            //jQuery ready ====================================

            $(function() {

                //defines function to be invoked when we click [+] to add field
                function addField() {
                    alert("adding");

                    //create fieldItem div (contains field name, field value)
                    var fieldItem = $('<div>').addClass('fieldItem').appendTo('#fields_div') //made sure you append it to our main div
                    .data('suffix', '.' + (fieldCount++));

                    //now pull field from its hidden template and add it to the fieldItem div above
                    $('div.template.fieldChooser').children().clone().appendTo(fieldItem).trigger('adjustName'); //trigger custom event for updating field count
                    fieldItem.bind('mouseover', mouseOverFieldItem);

                    function mouseOverFieldItem(event) {
                        $('button.removeFieldButton').appendTo(fieldItem);

                        $('button.removeFieldButton').live('click', function() {
                            button_clone = $(this).clone();
                            $(this).closest('div.fieldItem').remove();
                            $(this).appendTo('#removeFieldButtonDiv'); //before removing field, add back to the hidden template area
                        });
                    }

                }; //addField
                //define handler for [+] button
                $('button.addFieldButton').click(addField);

                //custom events
                //adjust field name
                $('.fieldItem [name]').live('adjustName', function() {
                    var suffix = $(this).closest('.fieldItem').data('suffix');
                    if (/(\w)+\.(\d)+$/.test($(this).attr('name'))) return;
                    $(this).attr('name', $(this).attr('name') + suffix);
                });

                //add an initial field when we first load the page
                //addField();
            });

            //end jQuery ready ====================================


        </script>
    </head>
    
    <body>
        <h2>
            Define Your DataType
        </h2>
        <form id="myForm" action="http://184.106.223.62/datatypes" method="post">
            <div id="datatype_fields">
                Name:
                <br>
                <input id="datatype_name" type="text" name="datatype_name">
                <br>
                <p>
                </p>
                Tags:
                <br>
                <input id="datatype_tags" type="text" name="datatype_tags">
                <br>
            </div>
            <p>
            </p>
            Fields:
            <button type="button" class="addFieldButton" title="Add new field">
                +
            </button>
            <div id="fields_div">
                <!--where fields go-->
            </div>
            <p>
            </p>
            
            <p>
            Comments: <br>
            <textarea id="comments" rows="3" cols="40"></textarea>
            </p>

            <p>
              <input type="submit" value="Add DataType"/> 
            </p>
                       <br>
        </form>
        <!--hidden templates-->
        <div id="templates" style="visibility:hidden">
            <!--individual field-->
            <div class="template fieldChooser">
                <input type="text" name="name" />
            </div>
            <div id="removeFieldButtonDiv">
                <button type="button" class="removeFieldButton" title="Remove field">
                    X
                </button>
            </div>
        </div>
    </body>

</html>
